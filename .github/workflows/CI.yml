name: build

on: [push, pull_request]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        rust: [ 1.90.0, 1.93.0 ]
    env:
      SCCACHE_GHA_ENABLED: "true"
      RUSTC_WRAPPER: "sccache"
      # maybe ninja dpdk auto detects sccache?
    steps:
    - uses: actions/checkout@v6

    - name: Run sccache-cache
      uses: mozilla-actions/sccache-action@v0.0.9
      with:
        version: "v0.10.0"

    - name: Remove toolchain file
      run: rm -f rust-toolchain.toml

    - name: Install rust stable
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy

    - uses: Swatinem/rust-cache@v2
      with:
        save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' }}

    - name: Install cmake
      uses: lukka/get-cmake@latest
      with:
        cmakeVersion: "~3.29.0" # Use version 3.29.x

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y meson ninja-build python3-pyelftools

    - name: Build and install dpdk
      run: |
        cmake -S . -B build
        cmake --build build --target dpdk_configure
        cmake --build build --target dpdk_build --parallel
        sudo cmake --build build --target dpdk_install

    - name: Run cargo check
      run: cargo +${{ matrix.rust }} check --all-targets

    - name: Run cargo fmt
      run: cargo +${{ matrix.rust }} fmt --all -- --check
    
    - name: Run cargo clippy
      run: cargo +${{ matrix.rust }} clippy --all-targets --all-features -- -D warnings
    
    - name: Run cargo test
      run: cargo +${{ matrix.rust }} test --all -- --nocapture

    - name: Build DPDK deb package
      # sudo needed: meson install writes to /usr/local log dir even with DESTDIR staging
      if: matrix.rust == '1.93.0'
      run: |
        sudo cmake --build build --target dpdk_deb

    - name: Build release binaries
      if: matrix.rust == '1.93.0'
      run: |
        cargo +${{ matrix.rust }} build --release --bin dpdk-bench-server --bin dpdk-bench-client

    - name: Upload DPDK deb artifact
      if: matrix.rust == '1.93.0'
      uses: actions/upload-artifact@v4
      with:
        name: dpdk-deb
        path: build/dpdk-net_*.deb
        if-no-files-found: error

    - name: Upload bench binaries artifact
      if: matrix.rust == '1.93.0'
      uses: actions/upload-artifact@v4
      with:
        name: bench-binaries
        path: |
          target/release/dpdk-bench-server
          target/release/dpdk-bench-client
        if-no-files-found: error

  e2e:
    # No 'needs: build' - runs in parallel, waits for artifacts via polling
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install libvirt and QEMU
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qemu-kvm libvirt-daemon-system libvirt-clients \
          libvirt-dev bridge-utils virtinst qemu-utils \
          cloud-image-utils ansible jq

    - name: Install Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: "1.14.4"

    - name: Setup libvirt
      run: |
        # Start libvirtd
        sudo systemctl start libvirtd
        sudo usermod -aG libvirt $USER
        
        # Allow current session to use libvirt (CI workaround)
        sudo chmod 666 /var/run/libvirt/libvirt-sock
        
        # Configure QEMU to run without security restrictions (for CI only)
        echo 'security_driver = "none"' | sudo tee -a /etc/libvirt/qemu.conf
        echo 'user = "root"' | sudo tee -a /etc/libvirt/qemu.conf
        echo 'group = "root"' | sudo tee -a /etc/libvirt/qemu.conf
        sudo systemctl restart libvirtd
        
        # Create default storage pool
        sudo mkdir -p /var/lib/libvirt/images
        sudo chmod 777 /var/lib/libvirt/images
        sudo virsh pool-define-as default dir --target /var/lib/libvirt/images || true
        sudo virsh pool-build default || true
        sudo virsh pool-start default || true
        sudo virsh pool-autostart default || true
        
        # Start default network
        sudo virsh net-start default || true
        
        # Verify access
        virsh list --all

    - name: Generate SSH key
      run: |
        ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""

    - name: Start local VMs (no-kvm)
      run: |
        ./tests/infra-local/scripts/start-vm.sh --no-kvm -y --no-color
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Wait for DHCP leases
      run: |
        echo "Waiting for VMs to get DHCP leases (this may take a while without KVM)..."
        for i in {1..120}; do
          VM1_IP=$(virsh net-dhcp-leases default 2>/dev/null | grep "dpdk-vm1" | awk '{print $5}' | cut -d'/' -f1)
          VM2_IP=$(virsh net-dhcp-leases default 2>/dev/null | grep "dpdk-vm2" | awk '{print $5}' | cut -d'/' -f1)
          if [[ -n "$VM1_IP" && -n "$VM2_IP" ]]; then
            echo "Both VMs have DHCP leases:"
            echo "  VM1: $VM1_IP"
            echo "  VM2: $VM2_IP"
            break
          fi
          echo "Attempt $i/120: Waiting..."
          sleep 5
        done
        # Show current leases
        virsh net-dhcp-leases default
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Wait for SSH to be ready
      run: |
        for vm in 1 2; do
          echo "Waiting for SSH on VM${vm}..."
          IP=$(virsh net-dhcp-leases default 2>/dev/null | grep "dpdk-vm${vm}" | awk '{print $5}' | cut -d'/' -f1)
          if [[ -z "$IP" ]]; then
            echo "ERROR: No IP for VM${vm}"
            exit 1
          fi
          for i in {1..60}; do
            if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=no -o BatchMode=yes \
                   -o UserKnownHostsFile=/dev/null azureuser@"$IP" "exit 0" 2>/dev/null; then
              echo "VM${vm} ($IP) SSH is ready"
              break
            fi
            echo "  Attempt $i/60: Waiting for SSH..."
            sleep 5
          done
        done
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Run connectivity test
      run: |
        ./tests/e2e/run_tests.sh --local playbooks/test_connectivity.yml
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Wait for build artifacts to be ready
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Waiting for build artifacts to be ready..."
        for i in {1..120}; do
          # Check if both artifacts exist
          ARTIFACTS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq '.artifacts[].name' 2>/dev/null || echo "")
          if echo "$ARTIFACTS" | grep -q "dpdk-deb" && echo "$ARTIFACTS" | grep -q "bench-binaries"; then
            echo "All artifacts are ready!"
            exit 0
          fi
          
          # Check if build job failed
          BUILD_STATUS=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs --jq '.jobs[] | select(.name | contains("build")) | select(.name | contains("1.93.0")) | .conclusion' 2>/dev/null | head -1)
          if [ "$BUILD_STATUS" = "failure" ] || [ "$BUILD_STATUS" = "cancelled" ]; then
            echo "Build job failed or was cancelled!"
            exit 1
          fi
          
          echo "Attempt $i/120: Waiting for artifacts... (found: $ARTIFACTS)"
          sleep 10
        done
        echo "Timeout waiting for artifacts"
        exit 1

    - name: Download DPDK deb artifact
      uses: actions/download-artifact@v4
      with:
        name: dpdk-deb
        path: build/

    - name: Download bench binaries artifact
      uses: actions/download-artifact@v4
      with:
        name: bench-binaries
        path: target/release/

    - name: List downloaded artifacts
      run: |
        echo "=== DPDK deb package ==="
        ls -la build/*.deb
        echo ""
        echo "=== Bench binaries ==="
        ls -la target/release/dpdk-bench-*
        chmod +x target/release/dpdk-bench-*

    - name: Setup DPDK on VMs
      run: |
        ./tests/e2e/run_tests.sh --local playbooks/setup_dpdk.yml
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Run HTTP server test (DPDK mode)
      run: |
        ./tests/e2e/run_tests.sh --local playbooks/http_server_test.yml
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"

    - name: Destroy VMs
      if: always()
      run: |
        ./tests/infra-local/scripts/destroy-vm.sh -y || true
      env:
        LIBVIRT_DEFAULT_URI: "qemu:///system"