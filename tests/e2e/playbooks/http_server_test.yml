---
# HTTP Server Test - Run DPDK HTTP server on VM1, test from VM2
# Usage:
#   DPDK mode (default): ./run_tests.sh playbooks/http_server_test.yml
#   Tokio mode: ./run_tests.sh playbooks/http_server_test.yml -e server_mode=tokio
#   Tokio-local mode: ./run_tests.sh playbooks/http_server_test.yml -e server_mode=tokio-local
#   Kimojio mode: ./run_tests.sh playbooks/http_server_test.yml -e server_mode=kimojio
#   Kimojio-poll mode: ./run_tests.sh playbooks/http_server_test.yml -e server_mode=kimojio-poll

- name: Setup HTTP Server Test
  hosts: vm1
  become: true

  vars:
    project_root: "{{ playbook_dir }}/../../../"
    bench_server_local: "{{ project_root }}/target/release/dpdk-bench-server"
    bench_server_remote: /home/azureuser/dpdk-bench-server

  tasks:
    - name: Get local binary checksum
      ansible.builtin.stat:
        path: "{{ bench_server_local }}"
        checksum_algorithm: md5
      register: local_binary
      delegate_to: localhost
      become: false

    - name: Get remote binary checksum
      ansible.builtin.stat:
        path: "{{ bench_server_remote }}"
        checksum_algorithm: md5
      register: remote_binary

    - name: Copy dpdk-bench-server to VM (if missing or hash mismatch)
      ansible.builtin.copy:
        src: "{{ bench_server_local }}"
        dest: "{{ bench_server_remote }}"
        mode: '0755'
      when: not remote_binary.stat.exists or (remote_binary.stat.checksum != local_binary.stat.checksum)

    - name: Verify binary copied
      ansible.builtin.shell: |
        ls -la {{ bench_server_remote }}
        file {{ bench_server_remote }}
      register: binary_info
      changed_when: false

    - name: Display binary info
      ansible.builtin.debug:
        msg: "{{ binary_info.stdout_lines }}"

- name: Setup Test Tools on VM2
  hosts: vm2
  become: true

  vars:
    project_root: "{{ playbook_dir }}/../../../"
    bench_client_local: "{{ project_root }}/target/release/dpdk-bench-client"
    bench_client_remote: /home/azureuser/dpdk-bench-client

  tasks:
    - name: Get local bench client checksum
      ansible.builtin.stat:
        path: "{{ bench_client_local }}"
        checksum_algorithm: md5
      register: local_client
      delegate_to: localhost
      become: false

    - name: Get remote bench client checksum
      ansible.builtin.stat:
        path: "{{ bench_client_remote }}"
        checksum_algorithm: md5
      register: remote_client

    - name: Copy dpdk-bench-client to VM (if missing or hash mismatch)
      ansible.builtin.copy:
        src: "{{ bench_client_local }}"
        dest: "{{ bench_client_remote }}"
        mode: '0755'
      when: not remote_client.stat.exists or (remote_client.stat.checksum != local_client.stat.checksum)

    - name: Verify bench client copied
      ansible.builtin.shell: |
        ls -la {{ bench_client_remote }}
        {{ bench_client_remote }} --help | head -5
      register: client_info
      changed_when: false

    - name: Display bench client info
      ansible.builtin.debug:
        msg: "{{ client_info.stdout_lines }}"

- name: Run HTTP Server Test with Cleanup
  hosts: vm1
  become: true

  vars:
    project_root: "{{ playbook_dir }}/../../../"
    build_dir: "{{ project_root }}/build"
    bench_server_remote: /home/azureuser/dpdk-bench-server
    bench_client_remote: /home/azureuser/dpdk-bench-client
    server_port: 8080
    # Server mode: 'dpdk' (default), 'tokio', 'tokio-local', or 'kimojio' - passed via -e server_mode=tokio
    _server_mode: "{{ server_mode | default('dpdk') }}"
    # Server start options based on mode
    server_start_opts: >-
      {%- if (server_mode | default('dpdk')) == 'tokio' -%}
      --mode tokio
      {%- elif (server_mode | default('dpdk')) == 'tokio-local' -%}
      --mode tokio-local
      {%- elif (server_mode | default('dpdk')) == 'kimojio' -%}
      --mode kimojio
      {%- elif (server_mode | default('dpdk')) == 'kimojio-poll' -%}
      --mode kimojio-poll
      {%- else -%}
      --backlog 200
      {%- endif -%}
    # IP address: NIC2 for DPDK, NIC1 for Tokio/Kimojio modes
    vm1_private_ip: "{{ hostvars['vm1'].private_ip if (server_mode | default('dpdk')) in ['tokio', 'tokio-local', 'kimojio', 'kimojio-poll'] else (hostvars['vm1'].private_ip2 | default(hostvars['vm1'].private_ip)) }}"

  tasks:
    - name: Run test with guaranteed cleanup
      block:
        - name: Debug server mode variables
          ansible.builtin.debug:
            msg: "server_mode={{ server_mode | default('NOT SET') }}, _server_mode={{ _server_mode }}, server_start_opts='{{ server_start_opts }}', vm1_private_ip={{ vm1_private_ip }}"

        - name: Kill any existing dpdk-bench-server
          ansible.builtin.shell: killall -9 dpdk-bench-server 2>/dev/null; exit 0
          changed_when: false

        - name: Ensure hugepages are configured
          ansible.builtin.shell: |
            echo 1024 > /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
            mkdir -p /mnt/huge
            mount -t hugetlbfs nodev /mnt/huge 2>/dev/null || true
          changed_when: false

        - name: Start HTTP server in background
          ansible.builtin.shell: |
            cd /home/azureuser
            export LD_LIBRARY_PATH=/usr/local/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
            ulimit -n 65535
            nohup {{ bench_server_remote }} {{ server_start_opts }} > /tmp/dpdk_bench_server.log 2>&1 &
            echo $!
          register: server_pid
          changed_when: true

        - name: Display server PID
          ansible.builtin.debug:
            msg: "HTTP server started with PID: {{ server_pid.stdout }} (mode: {{ _server_mode }}, ip: {{ vm1_private_ip }})"

        - name: Wait for server to start
          ansible.builtin.pause:
            seconds: 3

        - name: Check server is running
          ansible.builtin.shell: |
            echo "--- Checking for dpdk-bench-server process ---"
            ps aux | grep dpdk-bench-server | grep -v grep
            if [ $? -ne 0 ]; then
              echo "ERROR: Server not running!"
              echo "--- Server log ---"
              cat /tmp/dpdk_bench_server.log 2>/dev/null | tail -30 || echo "No log file"
              exit 1
            fi
          register: server_status
          changed_when: false

        - name: Display server status
          ansible.builtin.debug:
            msg: "{{ server_status.stdout_lines }}"

        # Test from VM2 using delegation
        - name: Wait for server to be ready
          ansible.builtin.pause:
            seconds: 3

        - name: Test with curl - basic request (from VM2)
          ansible.builtin.shell: |
            curl -o /dev/null -s --fail --connect-timeout 5 --max-time 10 http://{{ vm1_private_ip }}:{{ server_port }}/
          register: curl_result
          changed_when: false
          retries: 7
          delay: 2
          until: curl_result.rc == 0
          delegate_to: vm2

        - name: Test with curl - multiple requests (from VM2)
          ansible.builtin.shell: |
            for i in 1 2 3; do
              curl -o /dev/null -s --fail --connect-timeout 5 --max-time 10 http://{{ vm1_private_ip }}:{{ server_port }}/
              echo "Request $i: OK"
            done
          changed_when: false
          delegate_to: vm2

        - name: Create benchmark output directory on VM2
          ansible.builtin.file:
            path: /tmp/benchmarks
            state: directory
            mode: '0755'
          delegate_to: vm2

        - name: Run dpdk-bench-client benchmark matrix (from VM2)
          ansible.builtin.shell: |
            echo "=== Benchmark: {{ item.connections }} connections, {{ item.duration }} ==="
            ulimit -n 65535
            RUST_LOG=error {{ bench_client_remote }} -c {{ item.connections }} -d {{ item.duration }} http://{{ vm1_private_ip }}:{{ server_port }}/ 2>&1 | tee /tmp/benchmarks/bench_c{{ item.connections }}.json
            sleep 1s
          register: bench_results
          changed_when: false
          delegate_to: vm2
          loop:
            - { connections: 10, duration: "20s" }
            - { connections: 50, duration: "20s" }
            - { connections: 100, duration: "20s" }
            - { connections: 200, duration: "20s" }
            - { connections: 500, duration: "20s" }
            - { connections: 1000, duration: "20s" }
            - { connections: 2000, duration: "20s" }
          loop_control:
            label: "c{{ item.connections }}"

        - name: Display benchmark results
          ansible.builtin.debug:
            msg: "{{ item.stdout_lines }}"
          loop: "{{ bench_results.results }}"
          loop_control:
            label: "{{ item.item.connections }}c"

        - name: Generate benchmark summary on VM2
          ansible.builtin.shell: |
            cd /tmp/benchmarks
            echo '{"benchmark_time": "'$(date -Iseconds)'", "results": [' > summary.json
            first=true
            for f in bench_c*.json; do
              if [ "$first" = true ]; then
                first=false
              else
                echo "," >> summary.json
              fi
              cat "$f" >> summary.json
            done
            echo ']}' >> summary.json
            # Sort by connections and pretty print with jq if available
            if command -v jq &> /dev/null; then
              jq '.results |= sort_by(.connections)' summary.json > summary_sorted.json
              mv summary_sorted.json summary.json
              jq '.' summary.json
            else
              cat summary.json
            fi
          register: benchmark_summary
          changed_when: false
          delegate_to: vm2

        - name: Fetch benchmark results to local build directory
          ansible.builtin.fetch:
            src: "/tmp/benchmarks/{{ item }}"
            dest: "{{ build_dir }}/benchmarks/{{ _server_mode }}/"
            flat: true
          delegate_to: vm2
          loop:
            - bench_c10.json
            - bench_c50.json
            - bench_c100.json
            - bench_c200.json
            - bench_c500.json
            - bench_c1000.json
            - bench_c2000.json
            - summary.json
          ignore_errors: true

      always:
        # Cleanup always runs, even if tests fail
        - name: Stop HTTP server (send SIGTERM)
          ansible.builtin.shell: |
            pid=$(pidof dpdk-bench-server) || true
            if [ -n "$pid" ]; then
              kill -TERM $pid 2>/dev/null || true
              for i in 1 2 3 4 5; do
                kill -0 $pid 2>/dev/null || break
                sleep 1
              done
              kill -9 $pid 2>/dev/null || true
            fi
            sleep 1
          changed_when: false

        - name: Show final server log
          ansible.builtin.shell: cat /tmp/dpdk_bench_server.log 2>/dev/null | tail -50 || echo "No log"
          changed_when: false

        - name: Fetch server log to local build directory
          ansible.builtin.fetch:
            src: /tmp/dpdk_bench_server.log
            dest: "{{ build_dir }}/benchmarks/{{ _server_mode }}/bench_server.log"
            flat: true
          ignore_errors: true
